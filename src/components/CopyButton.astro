---
interface Props {
  text: string;
  label?: string;
}

const { text, label = "Copy" } = Astro.props;
const id = `copy-${Math.random().toString(36).slice(2, 8)}`;
---

<div class="copy-block">
  <span class="text-dark-dim select-none mr-2">$</span>
  <code class="flex-1 min-w-0 overflow-x-auto whitespace-nowrap text-dark-hi">{text}</code>
  <button
    id={id}
    data-copy={text}
    class="copy-btn"
    aria-label={`Copy command: ${text}`}
  >
    {label}
  </button>
  <span id={`${id}-status`} class="sr-only" aria-live="polite"></span>
</div>

<script>
  document.querySelectorAll<HTMLButtonElement>("[data-copy]").forEach((btn) => {
    const text = btn.dataset.copy!;
    const original = btn.textContent;
    const status = document.getElementById(btn.id + "-status");
    let timer: ReturnType<typeof setTimeout> | null = null;

    btn.addEventListener("click", () => {
      if (timer) clearTimeout(timer);
      btn.disabled = true;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = "Copied!";
        btn.classList.add("text-acid", "border-acid");
        if (status) status.textContent = "Copied to clipboard";
        timer = setTimeout(() => {
          btn.textContent = original;
          btn.classList.remove("text-acid", "border-acid");
          if (status) status.textContent = "";
          btn.disabled = false;
        }, 2000);
      }).catch(() => {
        btn.textContent = "Failed";
        btn.classList.add("text-err", "border-err");
        if (status) status.textContent = "Failed to copy command";
        timer = setTimeout(() => {
          btn.textContent = original;
          btn.classList.remove("text-err", "border-err");
          if (status) status.textContent = "";
          btn.disabled = false;
        }, 2000);
      });
    });
  });
</script>
